{% extends 'musette/base_musette.html' %}

{% load i18n %}
{% load static %}
{% load forum_tags %}
{% load hitcount_tags %}

{% block extra_js %}
    {{form_comment.media.js}}
    <script type="text/javascript">
        $('[data-toggle="tooltip"]').tooltip();
    </script>
{% endblock %}

{% block content %}

<div class="container" ng-controller="TopicController">

  {% get_hit_count for topic as total_hits %}

  <div>
    <div class="col-md-12">
        <div>
          <ul class="breadcrumb">
              <li><a href="{% url 'forums' %}">{% trans "Forums" %}</a></li>
              <li><a href="{% url 'forum' topic.forum.name %}">{{topic.forum.name}}</a></li>
              <li class="active">{{ topic.title }}</li>
          </ul>
        </div>

        <article class="row">
          <div class="col-md-12 col-sm-12">
            <div class="panel panel-default arrow left">
              <div class="panel-heading">
                <h3 class="panel-title"> 
                   {% if topic.is_top %}
                    <i class="fa fa-thumb-tack"></i>
                    {% endif %}
                   {{topic.title}}
                    </h3>
              </div>
              <div class="panel-body">

                <div class="pull-left col-md-2 post-info-left">
                  <figure class="thumbnail">
                        <img src="{{ photo }}" class="img-responsive" width="150" hegiht="150" />
                      <figcaption class="text-center">{{topic.user|get_path_profile|safe}}</figcaption>
                  </figure>
                  <table>
                    <tr>
                        <td>
                            <b>{% trans "Last Seen" %}</b>
                            {% if topic.user.user.last_seen %}
                                {{ topic.user.user.last_seen|timesince }}
                            {% else %}
                                {% trans "awhile ago" %}
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            {% if topic.user.user.online %}
                                <div class="label label-success"><b>Online</b></div>
                            {% else %}
                                <div class="label label-danger"><b>Online</b></div>
                            {% endif %}
                        </td>
                    </tr>
                  </table>
                </div>

                <div class="col-md-8">
                  <div class="comment-post">
                      {{topic.description|safe }}
                      
                      {% if topic.attachment %}
                        <img src="{{MEDIA_URL}}{{topic.attachment}}" class="img-responsive" />
                      {% endif %}
                    <hr>
                  </div>
                  <div class="pull-left">
                                        <p> <i class="fa fa-comments" aria-hidden="true"></i> {{ topic.idtopic|get_tot_comments }} </p>
                    {% if total_hits|add:"0" > 1 %}
                      <p style="margin-top: 5px;">{% trans "This topic has" %} {{ total_hits }} {% trans "views" %}</p>
                    {% else %}
                      <p style="margin-top: 5px;">{% trans "This topic has" %} {{ total_hits }} {% trans "view" %}</p>
                    {% endif %}
                    <p><b><u>{% trans "Users" %}</u></b> {{topic|get_tot_users_comments|safe}} </p>

                    {% if topic.user.id == user.id %}
                      <br>
                      <button onclick="document.location ='{% url 'edittopic' topic.forum.name topic.idtopic %}'" class="btn btn-inverse btn-xs" style="min-width: 8em">
                        <i class="fa fa-hand-o-up"></i> {% trans "Edit" %}</button>
                      <a style="cursor: pointer; min-width: 8em; margin-top: 0em" data-toggle="modal" data-target="#myModal" class="btn btn-danger btn-xs">
                        <i class="fa fa-trash"></i> {% trans "Delete" %}</a>
                    {% endif %}
                  </div>
                  <div class="pull-right">
                    <p>{{topic.date}}</p>
                    <a style="cursor: pointer" data-toggle="modal" data-target="#modelTopicShared">
                      <i class="fa fa-share"></i> {% trans "Share" %}
                    </a>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </article>
    </div>
  </div>

  <br>

  <div id="data-template" class="endless_page_template" endless-pagination="{'paginateOnScroll': true}">
      {% include "musette/topic.html" %}
  </div>

  {% comment %} Real time comment with angular {% endcomment %}
  <input type="hidden" ng-model="topic_id_ws" name="topic_id_ws" id="topic_musette" value="{{topic.idtopic}}" />

  {% verbatim %}
    <article ng-repeat="comment in comments_socket">
        <div class="col-lg-12">
          <div class="panel panel-default arrow left">
            <div class="panel-body">
              <header class="text-left">
                <time class="comment-date"><i class="fa fa-clock-o"></i>
                {% endverbatim %} {% trans "Now" %} {% verbatim %}</time>
              </header>
              <div class="comment-post">
                <div class="well" style="margin-top: 5px">
                 {{comment.description | htmlToPlaintext }}
                </div>
                <span>
                    <a href="{% url 'profile' comment.username %}">
                         <img class="img-circle" ng-src="{{ comment.photo }}""
                         width="30" height="30" />
                    </a>
                    <a href="{% url 'profile' comment.username %}">{{ comment.username }}</a>
                    <br>
                    <div class="label label-success"><b>Online</b></div>

                    <b>{% endverbatim %} {% trans "Last Seen" %} {% verbatim %}</b>
                    {% endverbatim %} 0 {% trans "minutes" %} {% verbatim %}
                </span>
              </div>
            </div>
          </div>
       </div>
      </article>
  {% endverbatim %}

  {% if comments.count > 0 %}
  <hr>
  {% endif %}

  <!-- New comment-->
  {% if user.id != None %}
    <div class="row">
    <div class="col-md-2"></div>
    <div class="col-md-8">
      <form action="{% url 'newcomment' topic.forum.name topic.slug topic.idtopic %}" name="formComment" method="POST" class="well">{% csrf_token%}
        <center>
        {% for field in form_comment %}
          {% if field.name == "description" %}
              <div class="form-group" ng-class="{ 'has-error' : formComment.description.$invalid && !formComment.description.$pristine }">
                <div class="in_div_textarea">
                  {{ field }}
                </div>
                {% if form_comment.description.errors %}
                  <div style="color: red">{{ form_comment.description.errors }}</div>
                {% endif %}
              </div>
          {% endif %}
        {% endfor %}
        </center>
        <button type="submit" class="btn btn-inverse btn-sm" ng-disabled="formComment.$invalid" ng-click="loading()">
            <i class="fa fa-plus"></i> {% trans "New comment" %}
        </button> <img src="{% static 'img/ajax.gif' %}" class="hide" />
      </form>
    </div>
    <div class="col-md-2"></div>
    </div>
  {% endif %}


</div>

{% if topic.user.id == user.id %}

    <!-- Modal remove topic-->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">{% trans "Delete topic" %}</h4>
          </div>
          <div class="modal-body">
            {% trans "Do you want to remove the topic?" %}
          </div>
          <div class="modal-footer">
            <form accept-charset="UTF-8" action="{% url 'deletetopic' topic.forum.name topic.idtopic %}" method="GET">
              <button type="submit" class="btn btn-danger">
                  <i class="fa fa-trash"></i> {% trans "Delete" %}
              </button>
          </form>
          </div>
        </div>
      </div>
    </div>

{% endif %}

<!-- Modal topic share -->
<div class="modal fade" id="modelTopicShared" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">{% trans "Share topic" %}</h4>
      </div>
      <div class="modal-body">
        <input type="text" class="form-control" onClick="this.select();" value="{{ request.build_absolute_uri }}" />
      </div>
      <div class="modal-footer social-share">
        <a href="http://www.facebook.com/sharer.php?s=100&amp;p%5Burl%5D={{ request.build_absolute_uri }}" target="_blank">
          <i class="fa fa-facebook"></i>
        </a>
        <a href="https://plus.google.com/share?url={{ request.build_absolute_uri }}" target="_blank">
          <i class="fa fa-google-plus"></i>
        </a>
        <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text={{ request.build_absolute_uri }}">
          <i class="fa fa-twitter"></i>
        </a>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block hitcount_javascript %}
{% insert_hit_count_js_variables for topic %}

{% endblock %}